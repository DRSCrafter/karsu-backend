# سامانه پشتیبان کارسو

پروژهٔ کارسو یک سرویس پشتیبان نوشته‌شده با **Node.js**, **Express** و **TypeScript** است که داده‌های کارگران، دستگاه‌های پوشیدنی آن‌ها و رویدادهای مرتبط را در پایگاه دادهٔ **PostgreSQL** نگه‌داری می‌کند. این سامانه برای پایش وضعیت سلامت کارگران و مدیریت هشدارهای ایمنی طراحی شده است.

## قابلیت‌ها
- فراهم کردن API کامل برای انجام عملیات CRUD روی تمامی مدل‌ها
- انتساب دستگاه‌ها به کارگران و پیگیری تاریخچهٔ استفاده
- ثبت حضور و غیاب شیفت‌ها
- ثبت شرایط و رویدادهای سلامت کارگران
- ذخیره‌سازی قرائت‌های حسگر (نبض، گاز، گام، زمان بی‌حرکتی، شارژ باتری)
- تولید و مدیریت هشدارهای ایمنی بر اساس داده‌های حسگر و حدود تعریف‌شده در نقش‌ها
- مدیریت نقش‌ها و مجوزها برای کنترل دسترسی
- ارائه‌ی مستندات کامل API در مسیر `/api-docs`

## مدل‌ها و روابط
### Worker (کارگر)
اطلاعات هویتی و تماس اضطراری کارگر را نگه‌داری می‌کند.
روابط:
- `assignments` : یک کارگر می‌تواند چندین انتساب دستگاه داشته باشد.
- `shifts` : ثبت حضور شیفت‌های کارگر.
- `healthConditions` : شرایط مزمن سلامت.
- `healthIncidents` : رویدادهای سلامتی مانند حادثه یا بیماری.
- `alerts` : هشدارهای ثبت‌شده برای کارگر.

### Device (دستگاه)
نمایندهٔ دستگاه پوشیدنی با شناسهٔ یکتا و وضعیت فعلی است.
روابط:
- `assignments` : دستگاه می‌تواند در دوره‌های مختلف به کارگران مختلف اختصاص یابد.
- `sensorReadings` : مجموعهٔ قرائت‌های ثبت‌شده توسط حسگرهای دستگاه.

### WorkerDeviceAssignment (انتساب دستگاه)
پل ارتباطی بین کارگر و دستگاه به همراه تاریخ شروع و پایان استفاده است. با حذف کارگر یا دستگاه، رکوردها به صورت خودکار حذف می‌شوند.

### ShiftAttendance (حضور شیفت)
برای هر کارگر، تاریخ و زمان ورود و خروج در شیفت‌ها را ثبت می‌کند.

### WorkerHealthCondition (شرایط سلامت)
شرایط مزمن مانند بیماری‌ها با شدت و وضعیت مدیریت می‌شوند.

### WorkerHealthIncident (رویداد سلامت)
رویدادهای موقت یا حادثه‌های مرتبط با سلامت کارگر به همراه تاریخ وقوع، شدت و تاریخ رفع ثبت می‌شوند.

### SensorReading (داده‌ی حسگر)
اطلاعات لحظه‌ای سنسورها برای هر دستگاه در زمان مشخص شامل: `heart_rate`، `gas_level`، `step_count`، `stationary_time` و `battery_level`.

### Alert (هشدار)
هشدارهای تولید شده بر اساس قرائت‌ها. هر هشدار نوعی (`alert_type`) دارد و می‌تواند زمان رفع داشته باشد.

### Role (نقش) و Permission (مجوز)
نقش‌ها شامل حدود مجاز برای نبض، گاز و بی‌حرکتی هستند و با مجوزها ارتباط چندبه‌چند دارند. مجوزها عملیات قابل انجام در سیستم را مشخص می‌کنند.

## راه‌اندازی پروژه
1. **نصب پیش‌نیازها**
   - Node.js نسخهٔ 16 یا بالاتر
   - پایگاه داده PostgreSQL
2. **کلون و نصب وابستگی‌ها**
   ```bash
   git clone <آدرس-مخزن>
   cd karsu-backend
   npm install
   ```
3. **تنظیم متغیرهای محیطی**
   فایل `.env` را با مقادیر پایگاه داده تکمیل کنید:
   ```env
   DB_HOST=localhost
   DB_PORT=5432
   DB_USERNAME=postgres
   DB_PASSWORD=رمزعبور
   DB_NAME=karsu
   ```
4. **ایجاد پایگاه داده**
   یک دیتابیس خالی با نامی که در `.env` مشخص کردید بسازید.
5. **اجرای مهاجرت‌ها**
   ```bash
   npm run migration:run
   ```
6. **اجرای برنامه**
   ```bash
   npm start
   ```
   سرویس به طور پیش‌فرض روی پورت 3000 در دسترس است و مستندات API در مسیر `http://localhost:3000/api-docs` قابل مشاهده است.

## اسکریپت‌های مفید
- `npm run build` : کامپایل TypeScript به JavaScript
- `npm run swagger:validate` : اعتبارسنجی فایل Swagger تولید شده
- `npm run migration:generate --name=MigrationName` : ایجاد فایل مهاجرت جدید
- `npm run migration:run` : اعمال مهاجرت‌ها روی پایگاه داده

این مخزن پایه‌ای برای توسعهٔ قابلیت‌های بیشتر سامانهٔ پایش سلامت کارگران است.
